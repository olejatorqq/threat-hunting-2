---
title: ""
author: "Oleg Orlovsky"
date: '2023-05-15'
output: md_document
---

### Подключение пакетов

```{r,warning=FALSE, message=FALSE, error=FALSE}
library(arrow)
library(dplyr)
library(stringr)
library(lubridate)
library(ggplot2)
```
### Импорт датасета

```{r,warning=FALSE, message=FALSE, error=FALSE}
dataset <- arrow::open_dataset("gowiththeflow_20190826.csv", format = "csv", schema = schema(timestamp=int64(),src=utf8(),dst=utf8(),port=uint32(),bytes=uint32()))

```

### Нахождение портов с наименее отправленными на них данными
```{r,warning=FALSE, message=FALSE, error=FALSE}
dataset %>%
  select(src, dst, bytes,port) %>%
  mutate(outside_traffic = (str_detect(src,"^((12|13|14)\\.)") & !str_detect(dst,"^((12|13|14)\\.)"))) %>%
  filter(outside_traffic == TRUE) %>%
  group_by(port) %>%
  summarise(total_data=sum(bytes)) %>%
  filter(total_data < 5*10^9) %>%
  select(port) %>%
  collect() -> ports

ports <- unlist(ports)
ports <- as.vector(ports,'numeric')
```

### Выборка данных с нужными номерами портов
```{r,warning=FALSE, message=FALSE, error=FALSE}
dataset %>%
  select(src, dst, bytes,port) %>%
  mutate(outside_traffic = (str_detect(src,"^((12|13|14)\\.)") & !str_detect(dst,"^((12|13|14)\\.)"))) %>%
  filter(outside_traffic == TRUE) %>%
  filter(port %in% ports) %>%
  group_by(src,port) %>%
  summarise(total_bytes=sum(bytes)) %>%
  arrange(desc(port)) %>%
  collect() -> dataframe
```

### Список портов с максимальным количеством данных
```{r,warning=FALSE, message=FALSE, error=FALSE}
dataframe %>%
  group_by(src, port) %>%
  summarise(total_data=sum(total_bytes)) %>%
  arrange(desc(total_data)) %>%
  head(10) %>%
  collect()
```

### Список количества хостов к портам
```{r,warning=FALSE, message=FALSE, error=FALSE}
dataframe %>%
  group_by(src, port) %>%
  summarise(total_data=sum(total_bytes)) %>%
  arrange(desc(total_data)) %>%
  head(10) %>%
  collect()
```

### Список количества хостов к портам

#### На основании предыдущих шагов можно сделать вывод, что злоумышленник использует IP-адрес 12.55.77.96 и порт 31. Это можно сказать, исходя из результатов предыдущего шага, где видно, что только один хост использовал порт 31, а также из результатов позапрошлого шага, где видно, что наибольшее количество данных было передано именно по этому порту.

```{r,warning=FALSE, message=FALSE, error=FALSE}
dataframe %>%
  filter(port == 31) %>%
  group_by(src) %>%
  summarise(total_data=sum(total_bytes)) %>%
  collect()
```

#### График отправленных байтов по портам
```
dataset %>%
  select(timestamp, src, dst, bytes, port) %>%
  mutate(external_traffic = (str_detect(src, "^((12|13|14)\\.)") & !str_detect(dst, "^((12|13|14)\\.)")), 
         hour = hour(as_datetime(timestamp/1000))) %>%
  filter(external_traffic == TRUE, hour >= 0 & hour <= 24) %>%
  group_by(port) %>%
  summarise(bytes = sum(bytes)) %>%
  collect() %>%
  ggplot(., aes(x = port, y = bytes)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Распределение отправленных байтов по портам", x = "Порт", y = "Количество байтов")
```
